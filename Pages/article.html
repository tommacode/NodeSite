<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;600&display=swap"
      rel="stylesheet"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tom Blake</title>
    <!--Meta Tags-->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:domain" content="tomblake.me" />
    <meta
      name="twitter:title"
      property="og:title"
      itemprop="name"
      content="Read the full article on Tomblake.me /articles"
    />
    <meta
      name="twitter:description"
      property="og:description"
      itemprop="description"
      content="Read the full article on Tomblake.me /articles"
    />
    <link rel="stylesheet" href="../css.css" />
  </head>
  <body onload="LoadComments()">
    <center>
      <div id="LoadingScreen">
        <div class="dots"></div>
        <p>Loading epic content</p>
      </div>
    </center>
    <div id="content">
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/projects">Articles</a></li>
        </ul>
      </nav>
      <!--Big header to draw attention-->
      <header>
        <h1>Loading</h1>
      </header>
      <!--Project Thumbnails-->
      <button onclick="like()" id="likeBtn" class="likeBtn">Likes: 0</button>
      <div id="projects">
        <div class="borders">
          <p style="float: right" id="date">Loading Date</p>
          <h3>Loading</h3>
          <!--Allow there to be html tags put in the content text-->
          <p id="content-text">Loading Information</p>
        </div>
      </div>
      <div class="borders">
        <h3>Write a comment:</h3>
        <p><sub>* fields are required</sub></p>
        <form>
          <input
            oninput="NameCounter()"
            type="text"
            id="name"
            placeholder="Name*"
          />
          <br />
          <sub id="NameCounterOutput" style="float: right">0/16</sub>
          <br />
          <input
            oninput="EmailCounter()"
            type="text"
            id="email"
            placeholder="Email"
          />
          <br />
          <sub id="EmailCounterOutput" style="float: right">0/255</sub>
          <br />
          <textarea
            style="width: 45vw"
            id="comment"
            placeholder="Comment*"
          ></textarea>
          <br />
          <button type="button" onclick="addComment(); LoadComments()">
            Add Comment
          </button>
        </form>
        <p id="response"></p>
      </div>
      <div id="comments" class="borders">
        <h3 id="commentTitle">Comments</h3>
      </div>
      <div id="footer">
        <h3>Footer</h3>
        <!--Links-->
        <ul class="linkBar">
          <li>
            <a
              target="_blank"
              href="https://github.com/tommacode"
              class="listLink"
              >My Github</a
            >
          </li>
          <li>
            <a
              target="_blank"
              href="https://tomhasawebsite.com"
              class="listLink"
              >Other Website</a
            >
          </li>
          <li><a href="#" class="listLink">Back to the top!</a></li>
        </ul>
      </div>
    </div>
    <script>
      //Wait until the content is loaded
      function HideLoadingScreen() {
        document.getElementById("content").style.display = "block";
        document.getElementById("LoadingScreen").style.display = "none";
      }
      //Load Content
      var http = new XMLHttpRequest();
      var currentUrl = window.location.href;
      //extract path from the url
      var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
      http.open("GET", `/api/projects/${path}`, true);
      http.send();
      http.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var data = JSON.parse(this.responseText);
          document.getElementsByTagName("h1")[0].innerHTML = data[0].Title;
          document.getElementsByTagName("h3")[0].innerHTML = data[0].Appetizer;
          document.getElementById("content-text").innerHTML = data[0].Content;
          document.getElementById(
            "likeBtn"
          ).innerHTML = `Likes: ${data[0].Likes}`;
          //Change the month to words
          var Time = data[0].Time;
          var month = Time.substring(5, 7);
          parseInt(month);
          var monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];
          var monthName = monthNames[month - 1];
          var Time =
            monthName +
            " " +
            Time.substring(8, 10) +
            ", " +
            Time.substring(0, 4);
          document.getElementById("date").innerHTML = Time;
          HideLoadingScreen();
        }
      };
      likeValue = 0;
      function like() {
        if (likeValue == 0) {
          var likes = document.getElementById("likeBtn").innerHTML;
          var likes = likes.substring(7, likes.length);
          var likes = parseInt(likes);
          likes++;
          document.getElementById("likeBtn").innerHTML = "Likes: " + likes;
          likeValue = 1;
          var http = new XMLHttpRequest();
          var currentUrl = window.location.href;
          var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
          http.open("GET", `/api/projects/${path}/like`, true);
          http.send();
        } else {
          var likes = document.getElementById("likeBtn").innerHTML;
          var likes = likes.substring(7, likes.length);
          var likes = parseInt(likes);
          likes--;
          document.getElementById("likeBtn").innerHTML = "Likes: " + likes;
          likeValue = 0;
          //Send the like to the server
          var http = new XMLHttpRequest();
          var currentUrl = window.location.href;
          //extract path from the url
          var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
          http.open("GET", `/api/projects/${path}/dislike`, true);
          http.send();
        }
      }

      //Counters for the ammount of characters in the fields
      function NameCounter() {
        var name = document.getElementById("name").value;
        var nameLength = name.length;
        if (nameLength > 16) {
          document.getElementById("name").value = name.substring(0, 16);
          var name = document.getElementById("name").value;
          var nameLength = name.length;
        }
        document.getElementById("NameCounterOutput").innerHTML =
          nameLength + "/16";
      }
      function EmailCounter() {
        var email = document.getElementById("email").value;
        var emailLength = email.length;
        if (emailLength > 255) {
          document.getElementById("email").value = email.substring(0, 255);
        }
        document.getElementById("EmailCounterOutput").innerHTML =
          emailLength + "/255";
      }
      //Post comment to the server
      function addComment() {
        var name = document.getElementById("name").value;
        var email = document.getElementById("email").value;
        var comment = document.getElementById("comment").value;
        //Clear all boxes
        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("comment").value = "";
        //Send the comment to the server
        var http = new XMLHttpRequest();
        var currentUrl = window.location.href;
        //extract path from the url
        var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
        http.open("POST", `/api/projects/${path}/comment`, true);
        http.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );
        http.send(`name=${name}&email=${email}&comment=${comment}`);
        http.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 204) {
            document.getElementById("response").innerHTML =
              "<b>Comment Posted!</b>";
          }
          if (this.readyState == 4 && this.status == 400) {
            document.getElementById("response").innerHTML =
              "<b>Error posting comment (May contain script tags)!</b>";
          }
          if (this.readyState == 4 && this.status == 429) {
            document.getElementById("response").innerHTML =
              "<b>You have posted too many comments in too little time</b>";
          }
          //Wait and then clear the response
          setTimeout(function () {
            document.getElementById("response").innerHTML = "";
          }, 2000);
        };
      }
      //Load comments
      function LoadComments() {
        //Clear the comments
        document.getElementById("comments").innerHTML = "";
        var http = new XMLHttpRequest();
        var currentUrl = window.location.href;
        //extract path from the url
        var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
        http.open("GET", `/api/projects/${path}/comments`, true);
        http.send();
        http.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            LikedComment = [];
            var h3 = document.createElement("h3");
            h3.innerHTML = `Comments (${data.length})`;
            document.getElementById("comments").appendChild(h3);
            for (var i = 0; i < data.length; i++) {
              var comment = document.createElement("div");
              comment.className = "borders";
              var name = document.createElement("h4");
              name.innerHTML = data[i].Name;
              var commentText = document.createElement("p");
              commentText.innerHTML = data[i].Content;
              //Add a like button to the comment
              var likeBtn = document.createElement("button");
              likeBtn.id = data[i].unique_id;
              likeBtn.className = "likeBtn";
              likeBtn.innerHTML = "Likes: " + data[i].Likes;
              likeBtn.id = data[i].Unique_id;
              LikedComment.push(likeBtn.id + ": 0");
              likeBtn.onclick = function () {
                if (
                  LikedComment[this.id] == 0 ||
                  LikedComment[this.id] == undefined
                ) {
                  LikedComment[this.id] = 1;
                  var likes = this.innerHTML;
                  var likes = likes.substring(7, likes.length);
                  var likes = parseInt(likes);
                  likes++;
                  this.innerHTML = "Likes: " + likes;
                  var http = new XMLHttpRequest();
                  var currentUrl = window.location.href;
                  //extract path from the url
                  var path = currentUrl.substring(
                    currentUrl.lastIndexOf("/") + 1
                  );
                  http.open("GET", `/api/comments/${this.id}/like/`, true);
                  http.send();
                } else {
                  LikedComment[this.id] = 0;
                  var likes = this.innerHTML;
                  var likes = likes.substring(7, likes.length);
                  var likes = parseInt(likes);
                  likes--;
                  this.innerHTML = "Likes: " + likes;
                  var http = new XMLHttpRequest();
                  var currentUrl = window.location.href;
                  //extract path from the url
                  var path = currentUrl.substring(
                    currentUrl.lastIndexOf("/") + 1
                  );
                  http.open("GET", `/api/comments/${this.id}/dislike`, true);
                  http.send();
                }
              };
              //Add the comment to the page
              comment.appendChild(name);
              comment.appendChild(commentText);
              comment.appendChild(likeBtn);
              document.getElementById("comments").appendChild(comment);
            }
          }
        };
      }
    </script>
  </body>
</html>
