<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="/login.js"></script>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Article</title>
    <!--Meta Tags-->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:domain" content="tomblake.me" />
    <meta
      name="twitter:title"
      property="og:title"
      itemprop="name"
      content="Read the full article on https://tomblake.me/articles"
    />
    <meta
      name="twitter:description"
      property="og:description"
      itemprop="description"
      content="Read the full article on https://tomblake.me/articles"
    />
    <link rel="stylesheet" href="../css.css" />
  </head>
  <body onload="LoadComments()">
    <div id="LoadingScreen">
      <div class="center" id="dots"></div>
      <p class="center" id="loadingText">Loading epic content</p>
    </div>
    <div id="content">
      <nav>
        <a href="/login" class="listLink" style="font-size: 1rem" id="loginInfo"
          >Not logged in</a
        >
        <ul>
          <li><a class="listLink" href="/">Home</a></li>
          <li><a class="listLink" href="/projects">Articles</a></li>
        </ul>
      </nav>
      <!--Big header to draw attention-->
      <header>
        <h1><%= Title %></h1>
      </header>
      <!--Project Thumbnails-->
      <button onclick="like(ArticleLikeTimeArray)" id="likeBtn" class="likeBtn">
        Likes: 0
      </button>
      <p id="likeMessage"></p>
      <div id="projects">
        <div class="borders">
          <p style="float: right" id="date"><%= Time %></p>
          <h3><%= Appetizer %></h3>
          <!--Allow there to be html tags put in the content text-->
          <p id="content-text"><%- Content %></p>
        </div>
      </div>
      <div class="borders" id="WriteComment">
        <h3 id="commentMessage">Write a comment:</h3>
        <form>
          <textarea
            style="width: 45vw"
            id="comment"
            placeholder="Comment*"
          ></textarea>
          <br />
          <button type="button" onclick="addComment()">Add Comment</button>
        </form>
        <p id="response"></p>
      </div>
      <div id="comments">
        <h3 id="commentTitle">Comments</h3>
        <!--Use ejs to render the comments the same as the javascript would-->
        <div id="commentList"></div>
      </div>
      <div id="footer">
        <h3>Footer</h3>
        <!--Links-->
        <ul class="linkBar">
          <li>
            <a
              target="_blank"
              href="https://github.com/tommacode"
              class="listLink"
              >My Github</a
            >
          </li>
          <li>
            <a
              target="_blank"
              href="https://tomhasawebsite.com"
              class="listLink"
              >Other Website</a
            >
          </li>
          <li><a href="#" class="listLink">Back to the top!</a></li>
        </ul>
      </div>
    </div>
    <p id="Liked" class="hidden"><%= Liked %></p>
    <p class="hidden" id="Likes"><%= Likes %></p>
    <script>
      //Wait until the content is loaded
      function HideLoadingScreen() {
        document.getElementById("content").style.display = "block";
        document.getElementById("LoadingScreen").style.display = "none";
      }
      let likeValue = document.getElementById("Liked").innerHTML;
      //Load Content
      let Likes = document.getElementById("Likes").innerHTML;

      document.getElementById("likeBtn").innerHTML = `Likes: ${Likes}`;
      HideLoadingScreen();
      ArticleLikeTimeArray = [];
      function ArticleRateLimit(ArticleLikeTimeArray) {
        var time = new Date().getTime();
        ArticleLikeTimeArray.push(time);
        var count = 0;
        for (var i = 0; i < ArticleLikeTimeArray.length; i++) {
          if (ArticleLikeTimeArray[i] > time - 10000) {
            count++;
          } else {
            ArticleLikeTimeArray.splice(i, 1);
          }
        }
        if (count > 5) {
          return false;
        } else {
          return true;
        }
      }
      function like(ArticleLikeTimeArray) {
        const RateLimit = ArticleRateLimit(ArticleLikeTimeArray);
        if (likeValue === "false" && RateLimit == true) {
          likeValue = "true";
          var http = new XMLHttpRequest();
          var currentUrl = window.location.href;
          var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
          http.open("GET", `/api/projects/${path}/like`, true);
          http.send();
          http.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 204) {
              var likes = document.getElementById("likeBtn").innerHTML;
              var likes = likes.split(" ")[1];
              var likes = parseInt(likes);
              likes++;
              document.getElementById("likeBtn").innerHTML = "Likes: " + likes;
            } else if (this.status == 429) {
              var time = new Date().getTime();
              for (var i = 0; i < 5; i++) {
                ArticleLikeTimeArray.push(time + 60000);
              }
            }
          };
        } else if (likeValue == "true" && RateLimit == true) {
          likeValue = "false";
          //Send the like to the server
          var http = new XMLHttpRequest();
          var currentUrl = window.location.href;
          //extract path from the url
          var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
          http.open("GET", `/api/projects/${path}/dislike`, true);
          http.send();
          http.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 204) {
              var likes = document.getElementById("likeBtn").innerHTML;
              var likes = likes.split(" ")[1];
              var likes = parseInt(likes);
              likes--;
              document.getElementById("likeBtn").innerHTML = "Likes: " + likes;
            } else if (this.status == 429) {
              var time = new Date().getTime();
              for (var i = 0; i < 3; i++) {
                ArticleLikeTimeArray.push(time + 60000);
              }
            }
          };
        }
      }
      //Post comment to the server
      function addComment() {
        var comment = document.getElementById("comment").value;
        //Clear all boxes
        document.getElementById("comment").value = "";
        //Send the comment to the server
        var http = new XMLHttpRequest();
        var currentUrl = window.location.href;
        //extract path from the url
        var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
        http.open("POST", `/api/projects/${path}/comment`, true);
        http.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );
        http.send(`comment=${comment}`);
        http.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 204) {
            document.getElementById("response").innerHTML =
              "<b>Comment Posted!</b>";
          }
          if (this.readyState == 4 && this.status == 400) {
            document.getElementById("response").innerHTML =
              "<b>Error posting comment (May contain script tags)!</b>";
          }
          if (this.readyState == 4 && this.status == 429) {
            document.getElementById("response").innerHTML =
              "<b>You have posted too many comments in too little time</b>";
          }
          //Wait and then clear the response
          setTimeout(function () {
            document.getElementById("response").innerHTML = "";
          }, 2000);
        };
      }
      //Load comments
      CommentLikeTimeArray = [];
      function CommentLikeRateLimit(CommentLikeTimeArray) {
        let time = new Date().getTime();
        CommentLikeTimeArray.push(time);
        let count = 0;
        for (var i = 0; i < CommentLikeTimeArray.length; i++) {
          if (CommentLikeTimeArray[i] > time - 5000) {
            count++;
          } else {
            CommentLikeTimeArray.splice(i, 1);
          }
        }
        if (count > 10) {
          return false;
        } else {
          return true;
        }
      }
      function LoadComments() {
        //Clear the comments
        document.getElementById("comments").innerHTML = "";
        var http = new XMLHttpRequest();
        var currentUrl = window.location.href;
        //extract path from the url
        var path = currentUrl.substring(currentUrl.lastIndexOf("/") + 1);
        http.open("GET", `/api/projects/${path}/comments`, true);
        http.send();
        http.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            LikedComment = [];
            var h3 = document.createElement("h3");
            h3.innerHTML = `Comments (${data.length})`;
            document.getElementById("comments").appendChild(h3);
            for (var i = 0; i < data.length; i++) {
              var comment = document.createElement("div");
              comment.className = "borders";
              var name = document.createElement("h4");
              name.innerHTML = data[i].Name;
              var commentText = document.createElement("p");
              commentText.innerHTML = data[i].Content;
              //Add a like button to the comment
              var likeBtn = document.createElement("button");
              likeBtn.id = data[i].unique_id;
              likeBtn.className = "likeBtn";
              likeBtn.innerHTML = "Likes: " + data[i].Likes;
              likeBtn.id = data[i].Unique_id;
              LikedComment.push(likeBtn.id + ": 0");
              if (data[i].Liked == true) {
                LikedComment[likeBtn.id] = 1;
              }
              likeBtn.onclick = function () {
                let Limit = CommentLikeRateLimit(CommentLikeTimeArray);
                if (
                  LikedComment[this.id] == 0 ||
                  (LikedComment[this.id] == undefined && Limit == true)
                ) {
                  LikedComment[this.id] = 1;
                  var likes = this.innerHTML;
                  var likes = likes.substring(7, likes.length);
                  var likes = parseInt(likes);
                  likes++;
                  this.innerHTML = "Likes: " + likes;
                  var http = new XMLHttpRequest();
                  var currentUrl = window.location.href;
                  //extract path from the url
                  var path = currentUrl.substring(
                    currentUrl.lastIndexOf("/") + 1
                  );
                  http.open("GET", `/api/comments/${this.id}/like`, true);
                  http.send();
                } else if (Limit == true) {
                  LikedComment[this.id] = 0;
                  var likes = this.innerHTML;
                  var likes = likes.substring(7, likes.length);
                  var likes = parseInt(likes);
                  likes--;
                  this.innerHTML = "Likes: " + likes;
                  var http = new XMLHttpRequest();
                  var currentUrl = window.location.href;
                  //extract path from the url
                  var path = currentUrl.substring(
                    currentUrl.lastIndexOf("/") + 1
                  );
                  http.open("GET", `/api/comments/${this.id}/dislike`, true);
                  http.send();
                }
              };
              //Add the comment to the page
              comment.appendChild(name);
              comment.appendChild(commentText);
              comment.appendChild(likeBtn);
              document.getElementById("comments").appendChild(comment);
            }
          }
          document.getElementById("comments").className = "borders";
        };
      }
    </script>
  </body>
</html>
